<div class="dash-wrap">

  <!-- Header -->
  <div class="dash-header">
    <div>
      <div class="dash-title">Dashboard</div> 

      <p-dropdown
      [options]="currencyOptions"
      [(ngModel)]="selectedCurrency"
      optionLabel="label"
      optionValue="value"
      [style]="{ width: '110px' }"
      (onChange)="onCurrencyChange($event.value)"
      ></p-dropdown>
      <i
        class="pi pi-info-circle opacity-70 cursor-pointer"
        pTooltip="{{ fxTooltip }}"
        tooltipPosition="bottom"
        [tooltipDisabled]="!fxTooltip"
      ></i>
    </div>

    <button
      pButton
      label="Añadir posición"
      icon="pi pi-plus"
      class="p-button-sm"
      (click)="openAddPosition()"
    ></button>
  </div>

  <!-- Loading -->
  <div class="dash-loading" *ngIf="loading">
    <p-progressSpinner styleClass="w-3rem h-3rem"></p-progressSpinner>
    <div class="opacity-70 mt-2">Cargando resumen...</div>
  </div>
 

  <!-- Content -->
  <ng-container *ngIf="data && !loading && !error">

    <!-- KPIs -->
    <div class="grid kpi-grid">
      <div class="col-12 md:col-4">
        <p-card styleClass="kpi-card">
          <div class="kpi-label">Total</div>
          <div class="kpi-value">
            {{ currencySymbol }}{{ data.totals.total | number:'1.2-2' }}
          </div>
          <div class="kpi-foot opacity-70">
            Portafolio: {{ data.scope.name }}
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-4">
        <p-card styleClass="kpi-card">
          <div class="kpi-label">Posiciones</div>
          <div class="kpi-value">
            {{ data.totals.positionsCount }}
          </div>
          <div class="kpi-foot opacity-70">
            Activos asignados en este scope
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-4">
        <p-card styleClass="kpi-card">
          <div class="kpi-label">Scope</div>
          <div class="kpi-value kpi-scope">
            {{ data.scope.name }}
          </div>
          <div class="kpi-foot opacity-70">
            Moneda: {{ data.currency }}
          </div>
        </p-card>
      </div>
    </div>

    <!-- Charts -->
<!-- Charts + Top table -->
<div class="grid mt-2" *ngIf="data.totals.total > 0">

  <!-- LEFT: Chart -->
  <div class="col-12 lg:col-8">

    <!-- ROOT: por portafolio -->
    <p-card *ngIf="isRootScope">
      <div class="card-title">Distribución por portafolio</div>
      <div class="chart-wrap">
        <canvas
          baseChart
          [type]="'pie'"
          [data]="pieByPortfolioDataset"
          [options]="pieOptions"
        ></canvas>
      </div>
    </p-card>

    <!-- SUBPORTFOLIO: por asset -->
    <p-card *ngIf="!isRootScope">
      <div class="card-title">Distribución por asset</div>
      <div class="chart-wrap">
        <canvas
          baseChart
          [type]="'pie'"
          [data]="pieByAssetDataset"
          [options]="pieOptions"
        ></canvas>
      </div>
    </p-card>

  </div>

  <!-- RIGHT: Top table -->
  <div class="col-12 lg:col-4">
    <p-card>
      <div class="card-title">
        {{ isRootScope ? 'Top subportfolios' : 'Top assets' }}
      </div>
      <!-- Controls: solo en subportfolio (Top assets) -->
      <div *ngIf="!isRootScope" class="flex align-items-center justify-content-between mb-2">
        <div class="flex align-items-center gap-2">
          <span class="text-sm opacity-70">Ordenar por</span>

          <p-dropdown
            [options]="sortOptions"
            [(ngModel)]="sortBy"
            optionLabel="label"
            optionValue="value"
            styleClass="p-dropdown-sm"
            [style]="{ width: '170px' }"
          ></p-dropdown>

          <button
            pButton
            type="button"
            class="p-button-sm p-button-text"
            (click)="toggleSortDir()"
            [pTooltip]="sortDir === 'desc' ? 'Mayor → menor' : 'Menor → mayor'"
            tooltipPosition="top"
          >
            <i class="pi" [ngClass]="sortDir === 'desc' ? 'pi-sort-amount-down' : 'pi-sort-amount-up'"></i>
          </button>
        </div>
      </div>

      <!-- ROOT: top subportfolios -->
      <p-table
        *ngIf="isRootScope"
        [value]="data.byPortfolio"
        styleClass="p-datatable-sm"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Nombre</th>
            <th class="text-right">%</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-row>
          <!-- Solo hijos del root: parentId = scopeId -->
          <ng-container *ngIf="row.parentId === data.scope.portfolioId">
            <tr>
              <td class="font-semibold">{{ row.name }}</td>
              <td class="text-right">
                {{ (row.total / data.totals.total * 100) | number:'1.0-1' }}%
              </td>
            </tr>
          </ng-container>
        </ng-template>
      </p-table>
      <!-- SUBPORTFOLIO: top assets -->
      <p-table
        *ngIf="!isRootScope"
        [value]="topAssetsSorted"
        styleClass="p-datatable-sm"
      >

        <!-- HEADER -->
        <ng-template pTemplate="header">
          <tr>
            <th>Asset</th>

            <th *ngIf="sortBy === 'qty'" class="text-right">Cantidad</th>
            <th *ngIf="sortBy === 'value'" class="text-right">Valor</th>
            <th *ngIf="sortBy === 'price'" class="text-right">Precio</th>

            <th class="text-right">Porcentaje</th>
          </tr>
        </ng-template>

        <!-- BODY -->
        <ng-template pTemplate="body" let-row>
          <tr>
            <!-- Asset + logo -->
            <td class="font-semibold">
              <div class="flex align-items-center gap-2">
                <img
                  *ngIf="row.logoUrl"
                  [src]="row.logoUrl"
                  alt=""
                  width="18"
                  height="18"
                  style="border-radius:999px;"
                  loading="lazy"
                  referrerpolicy="no-referrer"
                />
                <span
                  pTooltip="{{ (row.symbol || row.name) + '\n' +
                              'Precio: ' + (row.unitPrice !== null ? (currencySymbol + (row.unitPrice | number:'1.2-2')) : '—') + '\n' +
                              'Cantidad: ' + (row.quantity !== null ? (row.quantity | number:'1.0-6') : '—') + '\n' +
                              'Peso: ' + (row.weightPct | number:'1.0-1') + '%' }}"
                  tooltipPosition="top"
                >
                  {{ row.symbol || row.name }}
                </span>
              </div>
            </td>

            <!-- Cantidad -->
            <td *ngIf="sortBy === 'qty'" class="text-right">
              <ng-container *ngIf="row.quantity !== null; else noQty">
                {{ row.quantity | number:'1.0-6' }}
              </ng-container>
              <ng-template #noQty>—</ng-template>
            </td>

            <!-- Valor total -->
            <td *ngIf="sortBy === 'value'" class="text-right">
              {{ currencySymbol }}{{ row.valueAmount | number:'1.2-2' }}
            </td>

            <!-- Precio unitario -->
            <td *ngIf="sortBy === 'price'" class="text-right">
              <ng-container *ngIf="row.unitPrice !== null; else noPrice">
                {{ currencySymbol }}{{ row.unitPrice | number:'1.2-2' }}
              </ng-container>
              <ng-template #noPrice>—</ng-template>
            </td>

            <!-- Porcentaje -->
            <td class="text-right">
              {{ row.weightPct | number:'1.0-1' }}%
            </td>
          </tr>
        </ng-template>

      </p-table>

      <div class="text-sm opacity-70 mt-2">
        Total: {{ currencySymbol }}{{ data.totals.total | number:'1.2-2' }}
      </div>
    </p-card>
  </div>

</div>

    <!-- Tables -->
    <div class="grid mt-2">

      <!-- Por portafolio -->
      <div class="col-12 lg:col-6">
        <p-card>
          <div class="card-title">Por portafolio</div>

          <p-table
            [value]="data.byPortfolio"
            [paginator]="false"
            styleClass="p-datatable-sm"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Nombre</th>
                <th class="text-right">Total ({{ data.currency }})</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
              <tr>
                <td>
                  <div class="font-semibold">{{ row.name }}</div>
                  <div class="text-sm opacity-60" *ngIf="row.parentId === null">Root</div>
                </td>
                <td class="text-right">
                  {{ row.total | number:'1.2-2' }}
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="2" class="opacity-60">Sin datos</td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <!-- Por tipo -->
      <div class="col-12 lg:col-6">
        <p-card>
          <div class="card-title">Por tipo</div>

          <p-table
            [value]="data.byType"
            [paginator]="false"
            styleClass="p-datatable-sm"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Tipo</th>
                <th class="text-right">Total ({{ data.currency }})</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
              <tr>
                <td class="font-semibold">{{ row.type }}</td>
                <td class="text-right">
                  {{ row.total | number:'1.2-2' }}
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="2" class="opacity-60">Sin datos</td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

    </div>

  </ng-container>

  <!-- Modal Add Position (si ya lo tenías) -->
  <app-position-modal
    [open]="addPositionOpen"
    [defaultPortfolioId]="currentScopePortfolioId"
    (closed)="addPositionOpen = false"
    (saved)="reloadSummary()"
  ></app-position-modal>

</div>