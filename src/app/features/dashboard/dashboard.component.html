<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h2 class="mb-1">Dashboard</h2>
    <div class="text-muted small" *ngIf="data">
      Scope: <span class="text-light">{{ data.scope.name }}</span>
    </div>
  </div>

  <button class="btn btn-primary" (click)="openAddPosition()">
    + Añadir posición
  </button>
</div>

<app-position-modal
  [open]="addPositionOpen"
  [defaultPortfolioId]="currentScopePortfolioId"
  (closed)="addPositionOpen = false"
  (saved)="reloadSummary()"
></app-position-modal>


<!-- Loading -->
<div class="card border-0 shadow-sm mb-3" *ngIf="loading">
  <div class="card-body">
    <div class="d-flex align-items-center gap-3">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div>Cargando resumen...</div>
    </div>
  </div>
</div>

<!-- Error -->
<div class="alert alert-danger" *ngIf="error">
  {{ error }}
</div>

<!-- Content -->
<div *ngIf="data && !loading && !error">
  <!-- Top cards -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Total</div>
          <div class="display-6 mb-0">
            {{ data.totals.total | number:'1.2-2' }} {{ data.currency }}
          </div>
          <div class="text-muted small mt-2">
            Portafolio: {{ data.scope.name }}
          </div>
                <div class="row g-3 mb-4" *ngIf="data && data.totals.total > 0">
                    <div class="col-12 col-lg-6" *ngIf="isRootScope">
                        <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="mb-3">Distribución por portafolio</h5>

                            <canvas
                            baseChart
                            [type]="'pie'"
                            [data]="pieByPortfolioDataset"
                            [options]="pieOptions"
                            ></canvas>
                        </div>
                    </div>
                </div>
                  <div class="col-12 col-lg-6" *ngIf="!isRootScope">
                    <div class="card border-0 shadow-sm h-100">
                      <div class="card-body">
                        <h5 class="mb-3">Distribución por asset</h5>
                        <canvas baseChart [type]="'pie'" [data]="pieByAssetDataset" [options]="pieOptions"></canvas>
                      </div>
                    </div>
                  </div>
                <div class="alert alert-secondary" *ngIf="data && data.totals.total === 0">
                    Aún no hay posiciones con valor para generar gráficos.
                </div>
            </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Posiciones</div>
          <div class="display-6 mb-0">
            {{ data.totals.positionsCount }}
          </div>
          <div class="text-muted small mt-2">
            Activos asignados en este scope
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Scope</div>
          <div class="h4 mb-0">{{ data.scope.name }}</div>
          <div class="text-muted small mt-2">
            Moneda: {{ data.currency }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tables -->
  <div class="row g-3">
    <!-- By portfolio -->
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">Por portafolio</h5>
          </div>

          <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th class="text-end">Total ({{ data.currency }})</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of data.byPortfolio">
                  <td>
                    <div class="fw-semibold">{{ p.name }}</div>
                    <div class="text-muted small" *ngIf="p.parentId === null">Root</div>
                  </td>
                  <td class="text-end">
                    {{ p.total | number:'1.2-2' }}
                  </td>
                </tr>

                <tr *ngIf="data.byPortfolio.length === 0">
                  <td colspan="2" class="text-muted">Sin datos</td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

    <!-- By type -->
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">Por tipo</h5>
          </div>

          <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th class="text-end">Total ({{ data.currency }})</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let t of data.byType">
                  <td class="fw-semibold">{{ t.type }}</td>
                  <td class="text-end">{{ t.total | number:'1.2-2' }}</td>
                </tr>

                <tr *ngIf="data.byType.length === 0">
                  <td colspan="2" class="text-muted">Sin datos</td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
