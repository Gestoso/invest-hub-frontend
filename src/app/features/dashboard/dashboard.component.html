<div class="dash-wrap">

  <!-- Header -->
  <div class="dash-header">
    <div>
      <div class="dash-title">Dashboard</div> 
    </div>

    <button
      pButton
      label="Añadir posición"
      icon="pi pi-plus"
      class="p-button-sm"
      (click)="openAddPosition()"
    ></button>
  </div>

  <!-- Loading -->
  <div class="dash-loading" *ngIf="loading">
    <p-progressSpinner styleClass="w-3rem h-3rem"></p-progressSpinner>
    <div class="opacity-70 mt-2">Cargando resumen...</div>
  </div>
 

  <!-- Content -->
  <ng-container *ngIf="data && !loading && !error">

    <!-- KPIs -->
    <div class="grid kpi-grid">
      <div class="col-12 md:col-4">
        <p-card styleClass="kpi-card">
          <div class="kpi-label">Total</div>
          <div class="kpi-value">
            {{ data.totals.total | number:'1.2-2' }} {{ data.currency }}
          </div>
          <div class="kpi-foot opacity-70">
            Portafolio: {{ data.scope.name }}
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-4">
        <p-card styleClass="kpi-card">
          <div class="kpi-label">Posiciones</div>
          <div class="kpi-value">
            {{ data.totals.positionsCount }}
          </div>
          <div class="kpi-foot opacity-70">
            Activos asignados en este scope
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-4">
        <p-card styleClass="kpi-card">
          <div class="kpi-label">Scope</div>
          <div class="kpi-value kpi-scope">
            {{ data.scope.name }}
          </div>
          <div class="kpi-foot opacity-70">
            Moneda: {{ data.currency }}
          </div>
        </p-card>
      </div>
    </div>

    <!-- Charts -->
<!-- Charts + Top table -->
<div class="grid mt-2" *ngIf="data.totals.total > 0">

  <!-- LEFT: Chart -->
  <div class="col-12 lg:col-8">

    <!-- ROOT: por portafolio -->
    <p-card *ngIf="isRootScope">
      <div class="card-title">Distribución por portafolio</div>
      <div class="chart-wrap">
        <canvas
          baseChart
          [type]="'pie'"
          [data]="pieByPortfolioDataset"
          [options]="pieOptions"
        ></canvas>
      </div>
    </p-card>

    <!-- SUBPORTFOLIO: por asset -->
    <p-card *ngIf="!isRootScope">
      <div class="card-title">Distribución por asset</div>
      <div class="chart-wrap">
        <canvas
          baseChart
          [type]="'pie'"
          [data]="pieByAssetDataset"
          [options]="pieOptions"
        ></canvas>
      </div>
    </p-card>

  </div>

  <!-- RIGHT: Top table -->
  <div class="col-12 lg:col-4">
    <p-card>
      <div class="card-title">
        {{ isRootScope ? 'Top subportfolios' : 'Top assets' }}
      </div>

      <!-- ROOT: top subportfolios -->
      <p-table
        *ngIf="isRootScope"
        [value]="data.byPortfolio"
        styleClass="p-datatable-sm"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Nombre</th>
            <th class="text-right">%</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-row>
          <!-- Solo hijos del root: parentId = scopeId -->
          <ng-container *ngIf="row.parentId === data.scope.portfolioId">
            <tr>
              <td class="font-semibold">{{ row.name }}</td>
              <td class="text-right">
                {{ (row.total / data.totals.total * 100) | number:'1.0-1' }}%
              </td>
            </tr>
          </ng-container>
        </ng-template>
      </p-table>

      <!-- SUBPORTFOLIO: top assets -->
      <p-table
        *ngIf="!isRootScope"
        [value]="data.byAsset"
        styleClass="p-datatable-sm"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Asset</th>
            <th class="text-right">%</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-row>
          <tr>
            <td class="font-semibold">
              {{ row.symbol || row.name }}
            </td>
            <td class="text-right">
              {{ (row.total / data.totals.total * 100) | number:'1.0-1' }}%
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="text-sm opacity-70 mt-2">
        Total: {{ data.totals.total | number:'1.2-2' }} {{ data.currency }}
      </div>
    </p-card>
  </div>

</div>

    <!-- Tables -->
    <div class="grid mt-2">

      <!-- Por portafolio -->
      <div class="col-12 lg:col-6">
        <p-card>
          <div class="card-title">Por portafolio</div>

          <p-table
            [value]="data.byPortfolio"
            [paginator]="false"
            styleClass="p-datatable-sm"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Nombre</th>
                <th class="text-right">Total ({{ data.currency }})</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
              <tr>
                <td>
                  <div class="font-semibold">{{ row.name }}</div>
                  <div class="text-sm opacity-60" *ngIf="row.parentId === null">Root</div>
                </td>
                <td class="text-right">
                  {{ row.total | number:'1.2-2' }}
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="2" class="opacity-60">Sin datos</td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <!-- Por tipo -->
      <div class="col-12 lg:col-6">
        <p-card>
          <div class="card-title">Por tipo</div>

          <p-table
            [value]="data.byType"
            [paginator]="false"
            styleClass="p-datatable-sm"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Tipo</th>
                <th class="text-right">Total ({{ data.currency }})</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
              <tr>
                <td class="font-semibold">{{ row.type }}</td>
                <td class="text-right">
                  {{ row.total | number:'1.2-2' }}
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="2" class="opacity-60">Sin datos</td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

    </div>

  </ng-container>

  <!-- Modal Add Position (si ya lo tenías) -->
  <app-position-modal
    [open]="addPositionOpen"
    [defaultPortfolioId]="currentScopePortfolioId"
    (closed)="addPositionOpen = false"
    (saved)="reloadSummary()"
  ></app-position-modal>

</div>