<p-dialog
  header="Añadir posición"
  [(visible)]="open"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '520px' }"
  (onHide)="close()"
>
  <div class="flex flex-column gap-3">

    <div [formGroup]="form" class="flex flex-column gap-3">

      <!-- Portfolio -->
      <div class="flex flex-column gap-1">
        <label class="text-sm opacity-80">Portfolio</label>

        <p-dropdown
          formControlName="portfolioId"
          [options]="subportfolios"
          optionLabel="name"
          optionValue="id"
          placeholder="Selecciona un subportfolio"
          [filter]="true"
          filterBy="name"
        ></p-dropdown>

        <small class="opacity-60">
          No se permite añadir posiciones al portfolio raíz.
        </small>
      </div>

      <!-- CRYPTO MODE -->
      <ng-container *ngIf="isCryptoPortfolioSelected">
        <div class="flex flex-column gap-1">
          <label class="text-sm opacity-80">Criptomoneda</label>

          <span class="p-input-icon-left w-full">
            <i class="pi pi-search"></i>
            <input
              pInputText
              class="w-full"
              type="text"
              formControlName="cryptoSearch"
              placeholder="Buscar (BTC, Ethereum...)"
            />
          </span>

          <p-dropdown
            formControlName="cryptoSymbol"
            [options]="filteredCryptos"
            optionLabel="name"
            optionValue="symbol"
            placeholder="Selecciona una cripto"
            [filter]="true"
            filterBy="name,symbol"
          >
            <ng-template pTemplate="item" let-c>
              <div class="flex align-items-center justify-content-between w-full">
                <span class="font-semibold">{{ c.symbol }}</span>
                <span class="opacity-70">{{ c.name }}</span>
              </div>
            </ng-template>

            <ng-template pTemplate="selectedItem" let-c>
              <span *ngIf="c">{{ c.symbol }} — {{ c.name }}</span>
              <span *ngIf="!c" class="opacity-70">Selecciona una cripto</span>
            </ng-template>
          </p-dropdown>

          <small class="opacity-60">
            Los assets CRYPTO se crean automáticamente desde el catálogo.
          </small>
        </div>

        <!-- ✅ Nuevo: valueMode selector solo en CRYPTO -->
        <div class="flex flex-column gap-1">
          <label class="text-sm opacity-80">Tipo de posición</label>
          <p-selectButton
            formControlName="valueMode"
            [options]="valueModeOptions"
            optionLabel="label"
            optionValue="value"
          ></p-selectButton>
        </div>
      </ng-container>

      <!-- NON-CRYPTO MODE -->
      <ng-container *ngIf="!isCryptoPortfolioSelected">

        <div class="flex align-items-center justify-content-between">
          <label class="text-sm opacity-80">Activo</label>

          <button
            pButton
            type="button"
            class="p-button-text p-button-sm"
            icon="pi pi-plus"
            label="Nuevo asset"
            (click)="toggleCreateAsset()"
          ></button>
        </div>

        <p-dropdown
          formControlName="assetId"
          [options]="assetsFiltered"
          optionLabel="name"
          optionValue="id"
          placeholder="Selecciona un activo"
          [filter]="true"
          filterBy="name,symbol,type"
        >
          <ng-template pTemplate="item" let-a>
            <div class="flex align-items-center justify-content-between w-full">
              <span class="font-semibold">
                {{ a.name }} <span *ngIf="a.symbol" class="opacity-70">({{ a.symbol }})</span>
              </span>
              <span class="opacity-70 text-sm">{{ a.type }}</span>
            </div>
          </ng-template>
        </p-dropdown>

        <!-- Create asset panel -->
        <div *ngIf="showCreateAsset" class="p-3 border-round surface-border surface-card">
          <div class="font-semibold mb-2">Nuevo asset</div>

          <div [formGroup]="assetForm" class="flex flex-column gap-3">
            <div class="flex flex-column gap-1">
              <label class="text-sm opacity-80">Tipo</label>
              <p-dropdown
                formControlName="type"
                [options]="[
                  {label:'METAL', value:'METAL'},
                  {label:'ETF', value:'ETF'},
                  {label:'STOCK', value:'STOCK'},
                  {label:'CASH', value:'CASH'},
                  {label:'COMMODITY', value:'COMMODITY'},
                  {label:'OTHER', value:'OTHER'}
                ]"
                optionLabel="label"
                optionValue="value"
              ></p-dropdown>
            </div>

            <div class="flex flex-column gap-1">
              <label class="text-sm opacity-80">Nombre</label>
              <input pInputText type="text" formControlName="name" placeholder="Ej: Oro" />
            </div>

            <div class="flex flex-column gap-1">
              <label class="text-sm opacity-80">Símbolo (opcional)</label>
              <input pInputText type="text" formControlName="symbol" placeholder="Ej: XAU" />
            </div>

            <button
              pButton
              type="button"
              label="Crear asset"
              icon="pi pi-check"
              (click)="createAsset()"
              [disabled]="assetForm.invalid || loading"
              [loading]="loading"
            ></button>
          </div>
        </div>

      </ng-container>

      <p-divider></p-divider>

      <!-- ✅ ADD/SET -->
      <div class="flex flex-column gap-1">
        <label class="text-sm opacity-80">Aplicar</label>
        <p-dropdown
          formControlName="mode"
          [options]="upsertModeOptions"
          optionLabel="label"
          optionValue="value"
        ></p-dropdown>
      </div>

      <!-- MANUAL VALUE -->
      <ng-container *ngIf="(!isCryptoPortfolioSelected) || (isCryptoPortfolioSelected && form.value.valueMode === 'MANUAL')">
        <div class="flex flex-column gap-1">
          <label class="text-sm opacity-80">Valor (EUR)</label>
          <p-inputNumber
            formControlName="valueAmount"
            [min]="0"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            mode="decimal"
            inputStyleClass="w-full"
          ></p-inputNumber>
        </div>
      </ng-container>
 
      <!-- MARKET VALUE -->
      <ng-container *ngIf="isCryptoPortfolioSelected && form.value.valueMode === 'MARKET'">
        <div class="flex flex-column gap-1">
          <label class="text-sm opacity-80">Cantidad</label>
          <p-inputNumber
            formControlName="quantity"
            [minFractionDigits]="0"
            [maxFractionDigits]="12"
            mode="decimal"
            inputStyleClass="w-full"
          ></p-inputNumber>

          <small class="opacity-60">
            Introduces <b>cantidad</b> (BTC/ETH...). El valor total se calculará automáticamente con el
            <b>precio en tiempo real</b> en el dashboard.
            <br />
            El <b>coste</b> es opcional y se usará más adelante para calcular rentabilidad.
          </small>
        </div>

        <div class="flex flex-column gap-1">
          <label class="text-sm opacity-80">Coste (opcional)</label>
          <p-inputNumber
            formControlName="costAmount"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            mode="decimal"
            inputStyleClass="w-full"
          ></p-inputNumber>
        </div>

        <div class="flex flex-column gap-1">
          <label class="text-sm opacity-80">Moneda coste</label>
          <p-dropdown
            formControlName="costCurrency"
            [options]="['EUR','USD','GBP','JPY','CHF']"
            placeholder="EUR"
          ></p-dropdown>
        </div>
      </ng-container>

      <!-- Notes -->
      <div class="flex flex-column gap-1">
        <label class="text-sm opacity-80">Notas (opcional)</label>
        <input pInputText type="text" formControlName="notes" maxlength="255" />
      </div>
    </div>

    <!-- Footer -->
    <div class="flex justify-content-end gap-2 pt-2">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-text"
        (click)="close()"
        [disabled]="loading"
      ></button>

      <button
        pButton
        type="button"
        label="Guardar"
        icon="pi pi-save"
        (click)="save()"
        [loading]="loading"
        [disabled]="form.invalid || loading"
      ></button>
    </div>

  </div>
</p-dialog>